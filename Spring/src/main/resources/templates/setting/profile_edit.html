<!doctype html>

<html xmlns:th="http://www.thymleaf.org">

<head>
    <script type="text/javascript" src="/js/santaUtil.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.3/moment-with-locales.min.js"></script>
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    <link rel="stylesheet" href="/css/spinner.css" type="text/css">
    <link rel="stylesheet" href="/css/font.css" type="text/css">
    <link rel="stylesheet" href="/css/css.css" type="text/css">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body style="background-color: white">
<div class="wrap">
    <section class="main profile_my">
        <!-- header -->
        <header class="header">
            <a href="https://santa-community.co.kr/profile">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_2_882)">
                        <path d="M17.1699 24C17.0383 24.0007 16.9078 23.9755 16.786 23.9257C16.6641 23.876 16.5533 23.8027 16.4599 23.71L8.28988 15.54C7.82425 15.0755 7.45482 14.5238 7.20276 13.9163C6.95069 13.3089 6.82095 12.6577 6.82095 12C6.82095 11.3423 6.95069 10.6911 7.20276 10.0837C7.45482 9.4762 7.82425 8.92445 8.28988 8.45999L16.4599 0.290002C16.5531 0.196764 16.6638 0.122803 16.7856 0.0723425C16.9075 0.0218822 17.038 -0.00408935 17.1699 -0.00408936C17.3017 -0.00408936 17.4323 0.0218822 17.5541 0.0723425C17.676 0.122803 17.7866 0.196764 17.8799 0.290002C17.9731 0.38324 18.0471 0.49393 18.0975 0.615752C18.148 0.737574 18.174 0.868142 18.174 1C18.174 1.13186 18.148 1.26243 18.0975 1.38425C18.0471 1.50607 17.9731 1.61676 17.8799 1.71L9.70988 9.87999C9.14808 10.4425 8.83252 11.205 8.83252 12C8.83252 12.795 9.14808 13.5575 9.70988 14.12L17.8799 22.29C17.9736 22.3829 18.048 22.4935 18.0988 22.6154C18.1495 22.7373 18.1757 22.868 18.1757 23C18.1757 23.132 18.1495 23.2627 18.0988 23.3846C18.048 23.5064 17.9736 23.617 17.8799 23.71C17.7864 23.8027 17.6756 23.876 17.5538 23.9257C17.432 23.9755 17.3015 24.0007 17.1699 24Z" fill="#374957"/>
                    </g>
                    <defs>
                        <clipPath id="clip0_2_882">
                            <rect width="24" height="24" fill="white"/>
                        </clipPath>
                    </defs>
                </svg>
            </a>
            <h2 style="font-weight: bold; margin-top:1px;">프로필 수정</h2>
        </header>

        <form method="post" th:action="@{/profile/edit}" id="edit_form" style="font-size: .9rem;border-radius: 15rem;padding: 0.3rem 1.5rem;">
        <div class="profile_box">
            <div class="profile_info">
                <p><span></span></p>
                <div>
                    <div class="profile_img">
                        <img id="current_profile_image" th:src="${member.memberImage}" src="/img/circle_img.png" alt="" style="width: 100%; height: 100%;">
                        <input style="display: none;" type="file" id="new_profile_image" name="memberImage">
                    </div>
                    <button style="margin-top: 15px;" th:value="${member.memberImage}" id="profile_image_delete">프로필 삭제</button>
                </div>
                <p><span></span></p>
            </div>
        </div>

            <input type="hidden" name="socialId" th:value="${member.socialId}">
            <h6>닉네임</h6>
            <div class="form-group mb-3">
                <input type="text" class="form-control form-control-user" placeholder="닉네임을 입력하세요." id="name" name="nickname" th:value="${member.nickname}">
            </div>

            <h6>이메일</h6>
            <div class="form-group mb-3">
                <input type="text" class="form-control form-control-user" placeholder="이메일을 입력하세요." id="email" name="email" th:value="${member.email}">
            </div>

            <h6>전화번호</h6>
            <div class="form-group mb-3">
                <input type="text" class="form-control form-control-user" placeholder="전화번호를 입력하세요." id="phone" name="phone" th:value="${member.phone}">
            </div>

            <div class="form-group mb-4">
                <h6>연동정보</h6>
                <p><span style="color: #1ac99d" th:text="${member.socialType}">카카오</span> 로그인</p>
            </div>

            <div class="form-group mb-3" style="text-align: center;padding-top: 15px;">
                <h6 value="0" id="withDate">산타와 <span id="dateTime">0</span>동안 함께하고있습니다</h6>
            </div>

        </form>
            <div class="button-wrapper">
                <button class="button" id="edit_profile" style="margin-top: 0;">저장</button>
            </div>
    </section>
</div>

<script>
    $(function(){
        let createdDate = "[(${member.createdDate})]";
        let momentCreatedDate = moment().diff(moment(createdDate),"days");
        let momentCreatedTime = moment().diff(moment(createdDate),"hours");
        let momentCreatedMin =  moment().diff(moment(createdDate),"minutes");

        $("#dateTime").text(momentCreatedDate + "일");

        $("#withDate").on("click",function(){
            let thisVal = $(this).attr("value");
            if(thisVal == "0"){
                $("#dateTime").text(momentCreatedTime + "시간");
                $(this).attr("value","1");
            }else if(thisVal == "1"){
                $("#dateTime").text(momentCreatedMin + "분");
                $(this).attr("value","2");
            }else{
                $("#dateTime").text(momentCreatedDate + "일");
                $(this).attr("value","0");
            }
        });


        document.addEventListener("keydown", function (e){
            if (e.key === "Enter"){
                return;
            }
        });

    });

    // 이미지 미리보기
    function readImage(input) {
        // 인풋 태그에 파일이 있는 경우
        if(input.files && input.files[0]) {
            // 이미지 파일인지 검사 (생략)
            // FileReader 인스턴스 생성
            const reader = new FileReader();
            // 이미지가 로드가 된 경우
            reader.onload = e => {
                const previewImage = document.getElementById("current_profile_image");
                previewImage.src = e.target.result;
            }
            // reader가 이미지 읽도록 하기
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 새 이미지 리스너
    document.getElementById("new_profile_image").addEventListener("change", e => {
        readImage(e.target);
    });

    $("#profile_image_delete").on("click",function(){
        $("#current_profile_image").attr("src", "/img/defaultMemberImage.svg");
        document.getElementById("new_profile_image").addEventListener("change", e => {
            readImage(e.target);
        });
       return false;
    });

    // 프로필 이미지 선택시 Input file태그 실행
    $("#current_profile_image").on("click",function(){
        $("#new_profile_image").click();
    });

    $("#edit_profile").on("click",function (){
        let name = $("#name").val();
        let email = $("#email").val();
        let phone = $("#phone").val();

        if (name.trim() == "" || email.trim() == "" || phone.trim() == "" || name.length > 5) {
            return false;
        }

        if (!santaUtils.isValidEmail(email)) {
            Print.postMessage("이메일형식이 올바르지 않습니다.");
        }

        let bfUserNickname = "[(${member.nickname})]";

        if(bfUserNickname == name) {
            findImageStatus();
        }else{
            $("#edit_profile").attr("disabled",true);
            // 재검증
            $.ajax({
                type : "GET",
                url : "/sign/validate/" + name,
                success : function(res){
                    if(res == 1){
                        Print.postMessage("이미 존재하는 닉네임입니다.");
                        $("#edit_profile").attr("disabled",false);
                        return false;
                    }else{
                        findImageStatus();
                    }
                },
                error : function(XMLHttpRequest, textStatus, errorThrown){
                    console.log("닉네임 중복조회 실패");
                }
            });
        }
    });

    function findImageStatus(){
        if($("#new_profile_image").val()){
            let myImageUrl = uploadImage();
            $("#new_profile_image").remove();
            $(".profile_img").append("<input type=hidden value="+ myImageUrl +" name=memberImage>");
            $("#edit_form").submit();
        }else{
            let bfMemberImage = "[(${member.memberImage})]";
            $("#new_profile_image").remove();
            $(".profile_img").append("<input type=hidden value="+ bfMemberImage +" name=memberImage>");
            $("#edit_form").submit();
        }
    }

    function uploadImage() {
        let file = $('#new_profile_image')[0].files[0];
        if(!file) return;
        let formData = new FormData();
        formData.append('data', file);
        let imageurl;
        $.ajax({
            type: 'POST',
            url: '/upload/member',
            data: formData,
            processData: false,
            contentType: false,
            async: false
        }).done(function (data) {
            imageurl = data;
        }).fail(function (error) {

        });
        return imageurl;
    }


    $("#name").focusout(function (){
        this.value = this.value.trim();
    });
    $("#email").focusout(function (){
        this.value = this.value.trim();
        if (!santaUtils.isValidEmail(this.value)){
            Print.postMessage("이메일 형식이 맞지않습니다");
            $("#email").val("");
        }
    });

    $('#phone').on('input', function(){
        this.value = this.value.replace(/[^0-9]/g, '').replace(/(\..*)\./g, '$1');
        this.value = this.value.substr(0, 11);
    });
    $('#phone').focusout(function(){
        var str = this.value;
        str = str.replace(/[^0-9]/g, '').replace(/(\..*)\./g, '$1');
        var tmp = '';
        if(str.length < 7 && str.length > 3){
            tmp += str.substr(0, 3);
            tmp += '-';
            tmp += str.substr(3);
        }else if(str.length >= 7 && str.length < 11){
            tmp += str.substr(0, 3);
            tmp += '-';
            tmp += str.substr(3, 3);
            tmp += '-';
            tmp += str.substr(6);
        }else if(str.length == 11){
            tmp += str.substr(0, 3);
            tmp += '-';
            tmp += str.substr(3, 4);
            tmp += '-';
            tmp += str.substr(7);
        }else{
            tmp = str;
        }
        this.value = tmp;
    });

</script>


</body>
</html>
